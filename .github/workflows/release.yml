# GitHub Actions Release Pipeline for yandex-disk-photo-exporter
# Triggered on version tags (v*)
# Builds binaries for Linux (amd64/arm64), Windows (amd64/arm64), and macOS (amd64/arm64)

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GO_VERSION: '1.25'

jobs:
  # ===========================================================================
  # Generate Changelog from Conventional Commits
  # ===========================================================================
  changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Generate changelog
        id: changelog
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Get current and previous tags
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREVIOUS_TAG"
          
          # Get commits between tags
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log "${PREVIOUS_TAG}..${CURRENT_TAG}" --pretty=format:"%H|%s|%an" --reverse 2>/dev/null || echo "")
            COMPARE_URL="**Full Changelog**: https://github.com/${GITHUB_REPOSITORY}/compare/${PREVIOUS_TAG}...${CURRENT_TAG}"
          else
            COMMITS=$(git log "${CURRENT_TAG}" --pretty=format:"%H|%s|%an" --reverse 2>/dev/null || echo "")
            COMPARE_URL=""
          fi
          
          # Initialize category strings
          FEATURES=""
          FIXES=""
          PERFORMANCE=""
          OTHER=""
          
          # Parse commits and categorize
          while IFS= read -r line; do
            [ -z "$line" ] && continue
            
            HASH=$(echo "$line" | cut -d'|' -f1)
            MESSAGE=$(echo "$line" | cut -d'|' -f2)
            AUTHOR=$(echo "$line" | cut -d'|' -f3)
            
            SHORT_HASH="${HASH:0:7}"
            
            # Extract PR number if present
            PR_NUM=""
            if [[ "$MESSAGE" =~ \(#([0-9]+)\) ]]; then
              PR_NUM="${BASH_REMATCH[1]}"
            fi
            
            # Format the entry
            if [ -n "$PR_NUM" ]; then
              CLEAN_MSG=$(echo "$MESSAGE" | sed 's/ *(#[0-9]*)$//')
              ENTRY="* [\`${SHORT_HASH}\`](https://github.com/${GITHUB_REPOSITORY}/commit/${HASH}) : ${CLEAN_MSG} ([#${PR_NUM}](https://github.com/${GITHUB_REPOSITORY}/pull/${PR_NUM})) (@${AUTHOR})"
            else
              ENTRY="* [\`${SHORT_HASH}\`](https://github.com/${GITHUB_REPOSITORY}/commit/${HASH}) : ${MESSAGE} (@${AUTHOR})"
            fi
            
            # Categorize by conventional commit prefix
            case "$MESSAGE" in
              feat:*|feat\(*) 
                FEATURES="${FEATURES}${ENTRY}"$'\n'
                ;;
              fix:*|fix\(*) 
                FIXES="${FIXES}${ENTRY}"$'\n'
                ;;
              perf:*|perf\(*) 
                PERFORMANCE="${PERFORMANCE}${ENTRY}"$'\n'
                ;;
              docs:*|docs\(*|chore:*|chore\(*|build:*|build\(*|ci:*|ci\(*|refactor:*|refactor\(*|test:*|test\(*|style:*|style\(*)
                OTHER="${OTHER}${ENTRY}"$'\n'
                ;;
              *)
                OTHER="${OTHER}${ENTRY}"$'\n'
                ;;
            esac
          done <<< "$COMMITS"
          
          # Build changelog
          CHANGELOG="## Changelog"$'\n\n'
          
          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}### New Features"$'\n\n'"${FEATURES}"$'\n'
          fi
          
          if [ -n "$PERFORMANCE" ]; then
            CHANGELOG="${CHANGELOG}### Performance Improvements"$'\n\n'"${PERFORMANCE}"$'\n'
          fi
          
          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}### Bug Fixes"$'\n\n'"${FIXES}"$'\n'
          fi
          
          if [ -n "$OTHER" ]; then
            CHANGELOG="${CHANGELOG}### Other work"$'\n\n'"${OTHER}"$'\n'
          fi
          
          if [ -n "$COMPARE_URL" ]; then
            CHANGELOG="${CHANGELOG}${COMPARE_URL}"
          fi
          
          # Output changelog using heredoc for multiline
          {
            echo 'changelog<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

  # ===========================================================================
  # Linux Builds (native builds with .deb and .rpm packages)
  # ===========================================================================
  build-linux:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
          - os: ubuntu-24.04-arm
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build binary
        run: |
          mkdir -p bin
          go build -ldflags="-s -w -X main.appVersion=${{ steps.version.outputs.VERSION }}" \
            -o bin/yandex-disk-photo-exporter_${{ steps.version.outputs.VERSION }}_linux_${{ matrix.arch }} \
            .

      - name: Install nfpm
        run: go install github.com/goreleaser/nfpm/v2/cmd/nfpm@latest

      - name: Create nfpm config
        run: |
          cat > nfpm.yaml <<EOF
          name: yandex-disk-photo-exporter
          arch: ${{ matrix.arch }}
          platform: linux
          version: ${{ steps.version.outputs.VERSION }}
          maintainer: cantalupo555 <cantalupo@protonmail.com>
          description: |
            Automated tool for bulk downloading photos from Yandex Disk.
            Uses browser automation (chromedp) to select and download photos by date.
          vendor: cantalupo555
          homepage: https://github.com/cantalupo555/yandex-disk-photo-exporter
          license: MIT
          contents:
            - src: ./bin/yandex-disk-photo-exporter_${{ steps.version.outputs.VERSION }}_linux_${{ matrix.arch }}
              dst: /usr/bin/yandex-disk-photo-exporter
              file_info:
                mode: 0755
            - src: ./README.md
              dst: /usr/share/doc/yandex-disk-photo-exporter/README.md
              file_info:
                mode: 0644
          EOF

      - name: Build .deb package
        run: |
          nfpm package -p deb -f nfpm.yaml
          mv *.deb bin/yandex-disk-photo-exporter_${{ steps.version.outputs.VERSION }}_linux_${{ matrix.arch }}.deb

      - name: Build .rpm package
        run: |
          nfpm package -p rpm -f nfpm.yaml
          mv *.rpm bin/yandex-disk-photo-exporter_${{ steps.version.outputs.VERSION }}_linux_${{ matrix.arch }}.rpm

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-linux-${{ matrix.arch }}
          path: bin/*

  # ===========================================================================
  # Windows Builds (cross-compile from Linux)
  # ===========================================================================
  build-windows:
    strategy:
      matrix:
        include:
          - arch: amd64
          - arch: arm64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build binary (cross-compile)
        env:
          CGO_ENABLED: "0"
          GOOS: windows
          GOARCH: ${{ matrix.arch }}
        run: |
          mkdir -p bin
          go build -ldflags="-s -w -X main.appVersion=${{ steps.version.outputs.VERSION }}" \
            -o bin/yandex-disk-photo-exporter_${{ steps.version.outputs.VERSION }}_windows_${{ matrix.arch }}.exe \
            .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-windows-${{ matrix.arch }}
          path: bin/*

  # ===========================================================================
  # macOS Builds (cross-compile both architectures from Linux)
  # ===========================================================================
  build-macos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build binary (ARM64 - Apple Silicon)
        env:
          CGO_ENABLED: "0"
          GOOS: darwin
          GOARCH: arm64
        run: |
          mkdir -p bin
          go build -ldflags="-s -w -X main.appVersion=${{ steps.version.outputs.VERSION }}" \
            -o yandex-disk-photo-exporter \
            .
          zip bin/yandex-disk-photo-exporter_${{ steps.version.outputs.VERSION }}_macOS_arm64.zip yandex-disk-photo-exporter
          rm yandex-disk-photo-exporter

      - name: Build binary (AMD64 - Intel)
        env:
          CGO_ENABLED: "0"
          GOOS: darwin
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w -X main.appVersion=${{ steps.version.outputs.VERSION }}" \
            -o yandex-disk-photo-exporter \
            .
          zip bin/yandex-disk-photo-exporter_${{ steps.version.outputs.VERSION }}_macOS_amd64.zip yandex-disk-photo-exporter
          rm yandex-disk-photo-exporter

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-macos
          path: bin/*

  # ===========================================================================
  # Create GitHub Release with Custom Changelog
  # ===========================================================================
  release:
    needs: [changelog, build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: bin
          merge-multiple: true

      - name: List artifacts
        run: ls -la bin/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: bin/*
          body: ${{ needs.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
